##
# Ansible playbook for setting up a Go development server on Ubuntu 12.04.
#
---
- hosts: all
  #user: root
  user: vagrant
  sudo: yes

  vars_files:
    # Contains variables an settings required for installing the environement
    - vars/settings.yml
    # Contains configuration to deploy on the machine such as Apache vhost, mysql databases...
    - vars/configuration.yml

  tasks:

    ##
    # Update the box and install common softwares.
    #
    - name: Common | Install 'python-apt' module      
      apt: pkg=python-apt state=present
      tags: common

    - name: Common | Upgrade all packages
      apt: upgrade=yes update_cache=yes
      tags: common

    - name: Common | Install the locales package
      apt: pkg=locales state=present

    - name: Common | Ensure the locale exists
      command: /usr/sbin/locale-gen {{ locale }}

    - name: Common | Set the locale
      command: /usr/sbin/update-locale LANG={{ locale }} --reset


    ##
    # Installs NTP.
    #
    - name: Common | Install NTP
      apt: pkg={{ item }} state=present
      with_items:
        - ntp
        - ntpdate
      tags: common

    - name: Common | Install ntp.conf
      copy: src=templates/ntp.conf dest=/etc/ntp.conf owner=root group=root mode=0644
      tags: common

    ##
    # Apt package installation of common software.
    #
    - name: Common | Install misc utils.
      apt: pkg={{ item }} state=installed force=yes
      tags: common
      with_items:
        - htop
        - curl
        - python-software-properties
        - python-pycurl
        - software-properties-common
        - unzip
        - vim


    ##
    # Python setup
    #
    - name: Common | Install misc utils.
      apt: pkg={{ item }} state=installed force=yes
      tags: common
      with_items:
        - python-software-properties
        - python-pycurl
        - python-mysqldb


    ##
    # GIT, Mercurial and Bazaar setup.
    #
    - name: Git | Install git base packages
      apt: pkg={{ item }} state=installed force=yes
      tags: common
      with_items:
        - git-core
        - mercurial
        - bzr


    ##
    # Go Lang Setup.
    #
    - name: Go | Install Go base packages
      apt: pkg=golang state=installed force=yes
      tags: common

    - name: Go | Create directory for GOPATH
      file: path={{ go_path }} state=directory
      tags: common

    - name: Go | Set up environment variable for GOPATH
      lineinfile: dest=~/.bashrc regexp=^GOPATH= line="export GOPATH={{ go_path }}" state=present
      tags: common


    ##
    # Restart services
    #
    - name: Restart NTP
      action: service name=ntp state=restarted
      tags: common
